---
title: "Tugas Praktikum STA 582 Sesi UTS"
author: "Maulida Fajrining Tyas (G1501202041)"
date: "4/17/2021"
output: html_document
---
<style>
body {text-align: justify}
</style>
***
```{r package, echo=FALSE, include=FALSE}
library(tidyverse)
library(mlr3verse)
library(mlr3tuning)
library(mlr3extralearners)
library(ranger)
library(DataExplorer)
library(sjPlot)
library(skimr)
library(ggridges)
library(GGally)
```

## Metodologi Pemodelan

Tujuan dari pemodelan ini ialah untuk memprediksi harga untuk listing rumah baru kepada pemilik rumah yang akan menjual properti mereka di situs _AirBNB_. Hasil prediksi ini kemudian akan menjadi rekomendasi harga kepada pemilik rumah agar tetap kompetitif bahkan sebelum mereka memiliki ulasan mengenai properti mereka.

Untuk menjawab tujuan di atas, maka pemodelan SML _(Statistical Machine Learning)_ yang digunakan ialah _Random Forest_. Metode ini merupakan salah satu model yang _powerful_ dalam memprediksi respon dengan tipe numerik maupun kategorik. _Random Forest_ merupakan metode _ensemble_ dimana konsep yang digunakan yaitu menggabungkan/agregasi hasil prediksi dari banyak pohon keputusan _(Decision tree)_ untuk meningkatkan performa dari hasil prediksi. Keunggulan _Random Forest_ dibandingkan dengan metode _ensemble_ lainnya yaitu sifatnya dalam membentuk pohon-pohon keputusan _(Decision tree)_ akan memiliki variabel-variabel yang berbeda yang diambil secara acak. Hal ini kemudian yang akan membuat tiap pohon keputusan yang terbentuk tidak memiliki korelasi antar pohon dan dapat mereduksi varians.

Penelitian ini menggunakan _package_ dan ekosistem _mlr3_ pada R sebagai mesin untuk melakukan pemodelan SML. Pemrograman dengan _mlr3_ bersifat efisien, _object-oriented_, _extensible framework_ untuk klasifikasi, regresi, analisis survival, dan metode pembelajaran mesin statistika lainnya dengan bahasa R. Pada ekosistem _mlr3_ dapat dilakukan penggabungan model serta menyetel parameter pada model _(hyperparameter tuning, feature selection, and ensemble construction)_ dengan mudah untuk memperoleh hasil komparasi.  

Tahapan pemodelan yang akan dilakukan yaitu :  
1. Eksplorasi data  
2. Pra-pemrosesan data  
3. _Import_ data ke dalam _mlr3_  
4. _Tuning hyperparameter _   
5. Komparasi model sebelum dan setelah _tuning_  

***

### 1. Eksplorasi Data
```{r load train data, echo=FALSE}
setwd("D:/")
data_house<- read.csv("train.csv", stringsAsFactors = TRUE)
```

Mengenal data lebih jauh sangat penting sebelum masuk ke langkah pemodelan. Pada tahap eksplorasi data dapat diketahui sifat, karakter serta sebaran data yang akan digunakan juga dapat mendeteksi adanya pencilan atau _outlier_ serta nilai _NA_ pada data dengan jumlah yang sangat besar. 

```{r echo=TRUE}
plot_intro(data = data_house, geom_label_args = list(size=2.5))
```

Plot di atas menunjukkan bahwa data terdiri dari 62.1% variabel diskrit dan 37.9% variabel kontinu, serta memiliki 1.6% observasi yang hilang dari data keseluruhan. Namun, ternyata hanya terdapat 64.6% observasi lengkap yang tidak memiliki _missing values_.

Data yang digunakan merupakan data _house price_ yang terdiri dari 51879 observasi dengan 29 kolom yang terdiri dari 17 variabel bertipe faktor, 1 variabel bertipe logical _(TRUE/FALSE)_ dan 11 variabel bertipe numerik.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
skim_without_charts(data = data_house)
```


Berdasarkan tabel di atas, _missing values_ hanya terdapat pada variabel bertipe numerik dan paling banyak ada pada variabel `host_response_rate` dan `review_scores_rating`


```{r, echo=TRUE, message=FALSE}
plot_histogram(data=data_house,nrow=3, ncol=3,
               geom_histogram_args = list(fill="blue"))
```

Berdasarkan histogram yang ditampilkan pada variabel `price` atau harga dari properti di _AirBNB_, menunjukkan bahwa sebaran harga tidak menyebar secara normal dimana data menjulur ke kanan dan terdapat beberapa amatan yang memiliki harga yang jauh menyimpang dari rata-rata yang bernilai 160.3 satuan dan menjadi pencilan. Harga yang sangat tinggi ini mungkin dikarenakan terdapat beberapa properti yang memiliki fasilitas khusus atau mungkin berada pada lokasi strategis yang membuat harganya lebih mahal dari properti lain dengan fasilitas umum yang sama.

Hal menarik yang dapat dikatakan ialah pada situs _AirBNB_ tingkat respon dari pemilik rumah sangat baik yang ditunjukkan oleh histogram pada variabel `host_response_rate` yang kebanyakan bernilai 100%. Begitu pula dengan variabel `review_scores_rating` atau ulasan pada situs ini kebanyakan memiliki skor yang sangat baik. Hal ini berarti bahwa pengguna situs _AirBNB_ menyukai properti yang ditawarkan.

```{r, echo=TRUE}
data_house%>%
  filter(city %in% c("Boston","Chicago","DC","LA","NYC","SF"))%>%
  ggplot() +
  geom_boxplot(aes(x=city, y=price, fill=city), show.legend=F) +
  ggtitle("Sebaran Harga Rumah Setiap Kota") +
  ylab("Harga Rumah") +
  xlab("Kota") + 
  theme(plot.title = element_text(hjust = 0.5))+
  theme_bw()
```

Pada _boxplot_ di atas terlihat bahwa pada seluruh kota memiliki rata-rata harga yang sama yaitu berada pada harga sekitar 160-an satuan. Dilihat dari banyaknya titik data pencilan, LA menjadi kota yang memiliki banyak harga yang tinggi dibandingkan dengan kota lainnya. 


```{r, echo=TRUE, warning=FALSE}
ggcorr(data_house[,-1], method = c("everything","pearson"),geom = "tile")
```

Secara visual, dapat dilihat pada plot di atas bahwa korelasi yang terbentuk antara variabel prediktor terhadap harga hanya terdapat pada `number_of_reviews`, `longitude`, `latitude`,  dan `accomodates`. 

### 2. Pra-pemrosesan Data

Sebelum masuk ke tahap pemodelan, penting untuk melakukan pembersihan data agar data yang digunakan memiliki kualitas yang baik. Untuk tujuan prediksi respon bertipe numerik, maka variabel prediktor yang digunakan adalah semua yang bertipe numerik saja. `id` tidak digunakan karena hanya merupakan penanda untuk setiap unit properti sehingga tidak dipertimbangkan ke dalam model.

```{r pre-processing, echo=TRUE}
data_house <- data_house %>% 
  select(-id) %>%
  select_if(is.numeric) %>%
  na.omit()
```

### 3. _Import_ Data ke dalam _mlr3_

Langkah awal dalam menggunakan ekosistem _mlr3_ ialah dengan mendefinisikan `task` yang akan digunakan, karena dalam kasus ini kita akan memprediksi respon numerik, maka digunakan `TaskRegr`.

```{r, echo=TRUE}
task_house = TaskRegr$new(id="house", backend = data_house, target = "price")
```

Selanjutnya mendefinisikan model yang digunakan yaitu model _Random Forest_ yang menggunakan `package` dari `ranger`.

```{r, echo=TRUE}
model_rf <- lrn("regr.ranger", importance="impurity")
```

### 4. _Tuning Hyperparameter_

Pada tahap ini, akan didefinisikan parameter apa saja yang akan dioptimisasi agar dapat menghasilkan ukuran kebaikan terbaik (ukuran yang digunakan yaitu MAE).

Berikut adalah pendefinisian hyperparameter.

```{r tuning, echo=TRUE}
param_bound_rf <- ParamSet$new(params = list(ParamInt$new("mtry", 
                                                          lower = 2,
                                                          upper = 8),
                                             ParamInt$new("max.depth", 
                                                          lower = 1,
                                                          upper = 15)))
terminate = trm("evals", n_evals = 5) #stopping criteria
tuner <- tnr("random_search") #metode optimisasi
resample_inner = rsmp("cv", folds = 5)
```

Pada kasus ini, dipilih dua parameter yaitu `mtry` (banyaknya variabel yang terbentuk pada setiap pohon) dan `max.depth` (kedalaman pohon yang akan terbentuk).

`trm` = fungsi untuk kriteria penghentian dalam proses optimisasi  
`tnr` = fungsi untuk metode optimisasi yang digunakan  
`rsmp`= fungsi untuk melakukan _Cross-validation_.

Selanjutnya dibentuk fungsi `AutoTuner` dengan menggabungkan informasi dari sebelumnya.

```{r, echo=TRUE}
model_rf_tune <- AutoTuner$new(learner = model_rf,
                               measure = msr("regr.mae"),
                               terminator = terminate,
                               resampling = resample_inner,
                               search_space = param_bound_rf,
                               tuner = tuner,
                               store_models = TRUE)

resample_outer = rsmp("cv", folds = 5)
set.seed(1)
resample_outer$instantiate(task = task_house)
```

Perbedaan _resample inner_ dan _outer_ yaitu, pada _inner_ digunakan untuk _cross-validation_ untuk pembagian data dalam menentukan parameter terbaik dari rentang yang dipilih pada `param_bound_rf` kemudian setelah diperoleh maka akan dihitung performanya pada pembagian data dengan _resample outer_.

### 5. Komparasi Model Sebelum dan Sesudah Tuning

```{r echo=TRUE, message=FALSE, warning=FALSE}
model_house <- list(model_rf,
                    model_rf_tune)

design <- benchmark_grid(tasks = task_house,
                         learners = model_house,
                         resamplings = resample_outer)

lgr::get_logger("bbotk")$set_threshold("warn")
bmr = benchmark(design,store_models = TRUE)
```

Hasil komparasi adalah sebagai berikut.

```{r, echo=TRUE}
result = bmr$aggregate(msr("regr.mae"))
result
```

Hasil yang diperoleh menunjukkan bahwa nilai MAE _(mean absolute error)_ yang terendah ada pada model yang tidak di-tuned. 

***

## Pembahasan Hasil Pemodelan 

Setelah diperoleh model terbaik, langkah selanjutnya ialah melakukan interpretasi model dan prediksi pada data baru.

### 1. Parameter Terbaik 

Fungsi berikut digunakan untuk mengambil nilai parameter terbaik yang akan digunakan untuk prediksi.

```{r, echo=TRUE}
get_param_res <- function(i){
  as.data.table(bmr)$learner[[i]]$tuning_result
}

best_rf_param =map_dfr(6:10,get_param_res)
best_rf_param

best_rf_param %>% slice_min(regr.mae)

best_rf_param_value <-  c(best_rf_param %>%
                            slice_min(regr.mae) %>%
                            pull(mtry),
                          best_rf_param %>%
                            slice_min(regr.mae) %>%
                            pull(max.depth))
best_rf_param_value
```

### 2. Interpretasi Model

Dengan menggunakan nilai parameter terbaik, maka dibentuk model berdasarkan nilai parameter tersebut sebagai berikut.

```{r, echo=TRUE}
model_rf_best = lrn("regr.ranger", mtry=best_rf_param_value[1], 
                    max.depth=best_rf_param_value[2], importance="impurity")
model_rf_best$train(task = task_house)
```

Selanjutnya dapat diperoleh variabel mana saja yang berpengaruh besar terhadap model _Random Forest_ yang dibentuk.

```{r, echo=TRUE}
model_rf_best$model$variable.importance
importance <- data.frame(Predictors = names(model_rf_best$model$variable.importance),
                         impurity = model_rf_best$model$variable.importance)
rownames(importance) <- NULL
importance %>% arrange(desc(impurity))
```

Dapat dilihat bahwa variabel `bedrooms` memiliki nilai _importance_ tertinggi yang berarti `bedrooms` memiliki pengaruh yang besar dalam menentukan harga.

### 3. Prediksi
```{r load test data, echo=FALSE}
data_house_baru<- read.csv("test.csv", stringsAsFactors = TRUE)
```

Data baru yang akan digunakan untuk memprediksi terdiri dari 22232 observasi. Sebelum dilakukan prediksi, dilakukan pra-pemrosesan pada data baru untuk mengatasi adanya _missing values_ dan variabel bertipe selain numerik.

```{r, echo=TRUE}
data_house_baru <- data_house_baru %>% 
  arrange(id) %>%
  select(-id) %>% 
  select_if(is.numeric)
```

Dalam mengatasi adanya _missing values_, setiap baris dengan _missing values_ akan diganti dengan nilai tengah (median) dari kolom dimana baris itu berada.

```{r, echo=TRUE}
data_house_baru[is.na(data_house_baru)] = 0
data_house_baru$bathrooms[data_house_baru$bathrooms==0] = median(data_house_baru$bathrooms)
data_house_baru$host_response_rate[data_house_baru$host_response_rate==0] = median(data_house_baru$host_response_rate)
data_house_baru$review_scores_rating[data_house_baru$review_scores_rating==0] = median(data_house_baru$review_scores_rating)
data_house_baru$bedrooms[data_house_baru$bedrooms==0] = median(data_house_baru$bedrooms)
data_house_baru$beds[data_house_baru$beds==0] = median(data_house_baru$beds)
```

Setelah data sudah siap, dilakukan prediksi dengan hasil prediksi dapat dilihat sebagai berikut.

```{r, echo=TRUE}
prediksi_rf_new <- model_rf_best$predict_newdata(newdata = data_house_baru)
as.data.table(prediksi_rf_new)
```
